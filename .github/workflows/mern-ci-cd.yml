name: MERN ECommerce CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  OWNER: Seifdafiane  # REMPLACE par ton username GitHub rÃ©el
  BACKEND_IMAGE: mern-backend
  FRONTEND_IMAGE: mern-frontend
  BACKEND_PORT: 5001
  FRONTEND_PORT: 5173

jobs:
  # JOB 1: Tests Backend
  test-backend:
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:6
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password123
        options: >-
          --health-cmd="mongosh --eval 'db.runCommand(\"ping\").ok'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        ports:
          - 27017:27017
    
    steps:
    - name: ðŸ“¥ Checkout du code
      uses: actions/checkout@v3
    
    - name: âš™ï¸ Setup Node.js 18
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
    
    - name: ðŸ“¦ Install Backend Dependencies
      working-directory: ./backend
      run: npm ci
    
    - name: ðŸ§ª Run Backend Tests
      working-directory: ./backend
      run: npm test
      env:
        MONGODB_URI: mongodb://admin:password123@localhost:27017/ecommerce_test?authSource=admin
        JWT_SECRET: test_jwt_secret_academic_2024
        PORT: 5001
        NODE_ENV: test

  # JOB 2: Tests Frontend
  test-frontend:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout du code
      uses: actions/checkout@v3
    
    - name: âš™ï¸ Setup Node.js 18
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: ðŸ“¦ Install Frontend Dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: ðŸ§ª Run Frontend Tests
      working-directory: ./frontend
      run: npm test -- --watchAll=false --passWithNoTests
    
    - name: ðŸ—ï¸ Build Frontend Production
      working-directory: ./frontend
      run: npm run build

  # JOB 3: Build et Push Docker Images
  docker-build:
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    permissions:
      contents: read
      packages: write
      
    steps:
    - name: ðŸ“¥ Checkout du code
      uses: actions/checkout@v3
    
    - name: ðŸ³ Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ—ï¸ Build et Push Backend
      uses: docker/build-push-action@v4
      with:
        context: ./backend
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.BACKEND_IMAGE }}:latest
          ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }}
        build-args: |
          NODE_ENV=production
          PORT=${{ env.BACKEND_PORT }}
        labels: |
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
    
    - name: ðŸ—ï¸ Build et Push Frontend
      uses: docker/build-push-action@v4
      with:
        context: ./frontend
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.FRONTEND_IMAGE }}:latest
          ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
        build-args: |
          VITE_API_URL=http://localhost:${{ env.BACKEND_PORT }}/api
        labels: |
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}

  # JOB 4: DÃ©ploiement Staging (sur push sur develop)
  deploy-staging:
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - name: ðŸ“¥ Checkout du code
      uses: actions/checkout@v3
    
    - name: ðŸš€ Generate docker-compose.staging.yml
      run: |
        cat > docker-compose.staging.yml << 'EOF'
        version: '3.8'
        services:
          mongodb:
            image: mongo:6
            container_name: mongo-staging
            restart: unless-stopped
            ports:
              - "27017:27017"
            environment:
              MONGO_INITDB_ROOT_USERNAME: admin
              MONGO_INITDB_ROOT_PASSWORD: ${{ secrets.MONGO_PASSWORD }}
            volumes:
              - mongodb_data:/data/db
            command: ["--auth"]
          
          backend:
            image: ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }}
            container_name: backend-staging
            restart: unless-stopped
            ports:
              - "5001:${{ env.BACKEND_PORT }}"
            environment:
              NODE_ENV: staging
              MONGODB_URI: mongodb://admin:${{ secrets.MONGO_PASSWORD }}@mongodb:27017/ecommerce_staging?authSource=admin
              JWT_SECRET: ${{ secrets.JWT_SECRET }}
              PORT: ${{ env.BACKEND_PORT }}
            depends_on:
              - mongodb
            healthcheck:
              test: ["CMD", "curl", "-f", "http://localhost:${{ env.BACKEND_PORT }}/api/health"]
              interval: 30s
              timeout: 10s
              retries: 3
          
          frontend:
            image: ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
            container_name: frontend-staging
            restart: unless-stopped
            ports:
              - "${{ env.FRONTEND_PORT }}:80"
            environment:
              REACT_APP_API_URL: http://localhost:${{ env.BACKEND_PORT }}/api
            depends_on:
              backend:
                condition: service_healthy
        
        volumes:
          mongodb_data:
        EOF
        
        echo "ðŸ“‹ Fichier docker-compose.staging.yml gÃ©nÃ©rÃ©:"
        cat docker-compose.staging.yml
    
    - name: ðŸ“¤ Upload docker-compose as artifact
      uses: actions/upload-artifact@v3
      with:
        name: staging-config
        path: docker-compose.staging.yml

  # JOB 5: DÃ©ploiement Production (sur push sur main)
  deploy-production:
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“Š Generate Deployment Report
      run: |
        echo "ðŸŽ“ RAPPORT DE DÃ‰PLOIEMENT - TP ACADÃ‰MIQUE" > report.md
        echo "========================================" >> report.md
        echo "" >> report.md
        echo "ðŸ‘¨â€ðŸŽ“ Ã‰tudiant: Seif" >> report.md
        echo "ðŸ“… Date: $(date)" >> report.md
        echo "ðŸ”— Commit: ${{ github.sha }}" >> report.md
        echo "" >> report.md
        echo "## ðŸ“¦ Images Docker GÃ©nÃ©rÃ©es:" >> report.md
        echo "- **Frontend**: ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }}" >> report.md
        echo "- **Backend**: ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }}" >> report.md
        echo "" >> report.md
        echo "## ðŸ”Œ Configuration des Ports:" >> report.md
        echo "- Frontend: ${{ env.FRONTEND_PORT }}" >> report.md
        echo "- Backend API: ${{ env.BACKEND_PORT }}" >> report.md
        echo "- MongoDB: 27017" >> report.md
        echo "" >> report.md
        echo "## âœ… Jobs ExÃ©cutÃ©s:" >> report.md
        echo "1. âœ… Tests Backend" >> report.md
        echo "2. âœ… Tests Frontend" >> report.md
        echo "3. âœ… Build Docker Images" >> report.md
        echo "4. âœ… DÃ©ploiement Production" >> report.md
        
        cat report.md
    
    - name: ðŸŽ‰ Success Notification
      run: |
        echo "âœ… PIPELINE CI/CD RÃ‰USSI!"
        echo ""
        echo "Pour dÃ©ployer manuellement:"
        echo "1. RÃ©cupÃ©rer les images:"
        echo "   docker pull ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }}"
        echo "   docker pull ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }}"
        echo ""
        echo "2. Lancer avec docker-compose:"
        echo "   FRONTEND_PORT=${{ env.FRONTEND_PORT }} BACKEND_PORT=${{ env.BACKEND_PORT }} docker-compose up -d"
